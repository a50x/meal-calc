<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Safe Foods — Meal Plan Generator (Advanced)</title>
  <style>
    :root{--bg:#f7fafc;--card:#fff;--muted:#64748b;--accent:#06b6d4}
    body{font-family:Inter,system-ui,-apple-system,Arial;margin:18px;background:var(--bg);color:#0f172a}
    h1{margin:0 0 8px}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(11,20,37,0.06);margin-bottom:12px}
    label{display:inline-block;margin-right:10px;font-size:14px}
    input[type=number], select { padding:6px; margin-right:10px; width:110px; }
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    button{background:var(--accent);color:white;border:none;padding:9px 12px;border-radius:8px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
    .pill{display:inline-block;padding:8px 12px;border-radius:999px;background:#eef2f7;margin-right:8px}
    .muted{color:var(--muted)}
    .ok{color:green}.warn{color:crimson}
    .small{font-size:13px;color:var(--muted)}
    .footer-note{font-size:13px;color:#334155;margin-top:8px}
  </style>
</head>
<body>
  <h1>Safe Foods — Meal Plan Generator</h1>

  <div class="card">
    <div class="small muted">Set macro/calorie targets ± ranges. Choose meal count or Optimal (auto 3–5). Limit shakes/creami and meal repeats. Each meal can contain multiple foods or combos.</div>
    <div style="height:10px"></div>

    <div class="controls">
      <div>
        <label>Calories target</label><br>
        <input id="calTarget" type="number" value="2500" /> ± <input id="calRange" type="number" value="200" />
      </div>

      <div>
        <label>Protein target (g)</label><br>
        <input id="pTarget" type="number" value="190" /> ± <input id="pRange" type="number" value="15" />
      </div>

      <div>
        <label>Carb target (g)</label><br>
        <input id="cTarget" type="number" value="215" /> ± <input id="cRange" type="number" value="15" />
      </div>

      <div>
        <label>Fat target (g)</label><br>
        <input id="fTarget" type="number" value="65" /> ± <input id="fRange" type="number" value="10" />
      </div>

      <div>
        <label>Meals</label><br>
        <select id="mealCount">
          <option value="3">3</option>
          <option value="4" selected>4</option>
          <option value="5">5</option>
          <option value="optimal">Optimal (3–5)</option>
        </select>
      </div>

      <div>
        <label>Max shakes/creami (full portions)</label><br>
        <input id="maxShakes" type="number" value="2" />
      </div>

      <div>
        <label>Meal repeats allowed</label><br>
        <input id="maxRepeats" type="number" value="1" />
      </div>

      <div style="min-width:200px">
        <button onclick="generate()">Generate Day</button>
        <button onclick="exportCSV()" style="background:#2563eb;margin-left:8px">Export CSV</button>
      </div>
    </div>

    <div class="footer-note">Notes: Generator builds randomized daily plans (3–5 meals). Foods are chosen from your safe list with portions. If nothing matches, widen ranges or increase shake/repeat caps.</div>
  </div>

  <div id="result"></div>

<script>
// ===========================
// SAFE-FOOD DATABASE
// ===========================
const FOODS = [
  { id:"cereal_fairlife", name:"Protein Cheerios + Fairlife whole milk", kcal:300, p:16, c:36, f:10.5, tags:["combo"], portionable:false},
  { id:"cinnamon_cheerios", name:"Protein Cheerios (Cinnamon) + Horizon milk", kcal:300, p:16, c:36, f:10.5, tags:["combo"], portionable:false},
  { id:"bagel_cc", name:"Bagel + cream cheese", kcal:320, p:9, c:55, f:8, tags:["combo"], portionable:false},
  { id:"oatmeal_pkt", name:"Quaker Oatmeal (Maple pkt)", kcal:160, p:4, c:33, f:2, tags:["food"], portionable:false},

  { id:"cheeseburger", name:"Cheeseburger (patty + bun + ketchup)", kcal:430, p:30, c:32, f:16, tags:["meat","combo"], portionable:false},
  { id:"tenders", name:"Chicken tenders + ketchup", kcal:65, p:6, c:3.125, f:3.625, tags:["meat"], portionable:true, min:2, max:6, unit:"tender"},
  { id:"impossible_nuggets", name:"Impossible Nuggets + ketchup", kcal:48, p:2.6, c:3.8, f:2.4, tags:["meat"], portionable:true, min:1, max:5, unit:"nugget"},
  { id:"fishsticks", name:"Fish sticks + ketchup", kcal:70, p:3.2, c:6.4, f:3.6, tags:["meat"], portionable:true, min:1, max:6, unit:"piece"},

  { id:"rice_butter", name:"White rice + butter + NuSalt (1 cup)", kcal:275, p:4, c:45, f:9, tags:["carb"], portionable:true, min:1, max:3, unit:"cup"},
  { id:"tots_120", name:"Tater tots (120g)", kcal:360, p:3, c:45, f:17, tags:["carb"], portionable:false},
  { id:"fries_80", name:"French fries (80g)", kcal:200, p:2.5, c:30, f:8, tags:["carb"], portionable:false},
  { id:"annies_mac", name:"Annie's Protein Mac & Cheese", kcal:320, p:15, c:60, f:6, tags:["carb"], portionable:false},
  { id:"barilla_protein_pasta", name:"Barilla Protein+ pasta + marinara", kcal:190, p:17, c:35, f:2, tags:["carb"], portionable:false},
  { id:"corn_cup", name:"Corn (1 cup)", kcal:200, p:4, c:31, f:4, tags:["carb"], portionable:false},

  { id:"ghost", name:"Ghost Protein + Horizon milk", kcal:250, p:30, c:12, f:5, tags:["shake"], portionable:false},
  { id:"carnation", name:"Carnation Breakfast Essentials RTD", kcal:220, p:15, c:27, f:6, tags:["shake"], portionable:false},
  { id:"creami_vanilla", name:"Vanilla Protein Creami", kcal:210, p:38, c:10, f:2, tags:["shake"], portionable:false},
  { id:"creami_cookies", name:"Cookies & Cream Protein Creami", kcal:170, p:26, c:6, f:3, tags:["shake"], portionable:false},
  { id:"creami_brownie", name:"Brownie Batter Protein Creami", kcal:220, p:35, c:13, f:3, tags:["shake"], portionable:false},
  { id:"creami_birthday", name:"Birthday Cake Protein Creami", kcal:200, p:36, c:9, f:2, tags:["shake"], portionable:false},
  { id:"creami_sundae", name:"Brownie Sundae Remix Creami", kcal:330, p:42, c:28, f:6, tags:["shake"], portionable:false},

  { id:"oui_vanilla", name:"Oui Vanilla yogurt", kcal:180, p:5, c:20, f:8, tags:["snack"], portionable:false},
  { id:"ricekrispie", name:"Rice Krispie Treat", kcal:120, p:2, c:17, f:3, tags:["snack"], portionable:false},
  { id:"chobani_flip", name:"Chobani Flip (S'mores/Cookie Dough/Bday/Cookies & Cream)", kcal:160, p:9, c:21, f:4.5, tags:["snack"], portionable:false},

  { id:"banana", name:"Banana (med)", kcal:105, p:1, c:27, f:0, tags:["snack"], portionable:false},
  { id:"apple", name:"Apple (med)", kcal:80, p:0, c:22, f:0, tags:["snack"], portionable:false}
];

// helpers
function clone(obj){ return JSON.parse(JSON.stringify(obj)); }
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function sample(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function pickPortion(food){
  if(!food.portionable) return {...food, qty:1};
  const qty = rand(food.min, food.max);
  return {...food, qty, kcal:food.kcal*qty, p:food.p*qty, c:food.c*qty, f:food.f*qty,
          name:`${food.name} x${qty} ${food.unit}${qty>1?'s':''}`};
}
function isShake(item){ return item.tags && item.tags.includes("shake"); }

function getTargets(){
  return {
    calMin:+calTarget.value - +calRange.value,
    calMax:+calTarget.value + +calRange.value,
    pMin:+pTarget.value - +pRange.value,
    pMax:+pTarget.value + +pRange.value,
    cMin:+cTarget.value - +cRange.value,
    cMax:+cTarget.value + +cRange.value,
    fMin:+fTarget.value - +fRange.value,
    fMax:+fTarget.value + +fRange.value
  };
}

function score(tot, targ){
  const mid=(min,max)=>(min+max)/2;
  return Math.abs(tot.p-mid(targ.pMin,targ.pMax))*4 +
         Math.abs(tot.c-mid(targ.cMin,targ.cMax))*2 +
         Math.abs(tot.f-mid(targ.fMin,targ.fMax))*1 +
         Math.abs(tot.cal-mid(targ.calMin,targ.calMax))*0.2;
}

function buildCandidate(mealsN, maxShakes,maxRepeats){
  let meals=[],tot={cal:0,p:0,c:0,f:0},shakes=0,counts={};
  for(let m=0;m<mealsN;m++){
    let items=[],count=rand(1,3),tries=0;
    while(items.length<count && tries<50){
      tries++;
      let cand=pickPortion(sample(FOODS));
      if(isShake(cand) && shakes+1>maxShakes) continue;
      if((counts[cand.id]||0)+1>maxRepeats) continue;
      items.push(cand);
      tot.cal+=cand.kcal; tot.p+=cand.p; tot.c+=cand.c; tot.f+=cand.f;
      if(isShake(cand)) shakes++;
      counts[cand.id]=(counts[cand.id]||0)+1;
    }
    if(!items.length) return null;
    meals.push({items});
  }
  return {meals,tot,shakes};
}

function bestForMeals(n,targ){
  let best=null,maxS=+maxShakes.value,maxR=+maxRepeats.value;
  for(let i=0;i<2000;i++){
    let c=buildCandidate(n,maxS,maxR);
    if(!c) continue;
    if(c.tot.cal>targ.calMax) continue;
    let sc=score(c.tot,targ);
    if(!best||sc<best.score){c.score=sc;best=c;}
    if(c.tot.cal>=targ.calMin&&c.tot.cal<=targ.calMax &&
       c.tot.p>=targ.pMin&&c.tot.p<=targ.pMax &&
       c.tot.c>=targ.cMin&&c.tot.c<=targ.cMax &&
       c.tot.f>=targ.fMin&&c.tot.f<=targ.fMax) return c;
  }
  return best;
}

function generate(){
  let targ=getTargets(),choice=mealCount.value;
  let best=null;
  if(choice==="optimal"){
    let opts=[];
    for(let n=3;n<=5;n++){let c=bestForMeals(n,targ);if(c)opts.push({...c,mealsN:n});}
    if(!opts.length){result.innerHTML="<div class='card'><b>No plan found.</b></div>";return;}
    opts.sort((a,b)=>a.score-b.score);best=opts[0];
  }else{
    let n=+choice,c=bestForMeals(n,targ);
    if(!c){result.innerHTML=`<div class='card'><b>No plan found for ${n} meals.</b></div>`;return;}
    best={...c,mealsN:n};
  }
  render(best,targ);
}

function render(plan,targ){
  let html=`<div class="card"><h3>Generated Day — ${plan.mealsN} meals</h3>`;
  let g={cal:0,p:0,c:0,f:0};
  plan.meals.forEach((m,i)=>{
    let mc=0,mp=0,cc=0,fc=0;
    html+=`<h4>Meal ${i+1}</h4><table><thead><tr><th>Food</th><th>kcal</th><th>P</th><th>C</th><th>F</th></tr></thead><tbody>`;
    m.items.forEach(it=>{
      html+=`<tr><td>${it.name}</td><td>${it.kcal}</td><td>${it.p}</td><td>${it.c}</td><td>${it.f}</td></tr>`;
      mc+=it.kcal; mp+=it.p; cc+=it.c; fc+=it.f;
    });
    html+=`<tr style="font-weight:700"><td>Subtotal</td><td>${mc}</td><td>${mp}</td><td>${cc}</td><td>${fc}</td></tr></tbody></table>`;
    g.cal+=mc;g.p+=mp;g.c+=cc;g.f+=fc;
  });
  html+=`<div style="margin-top:10px"><span class="pill">Calories: ${g.cal}</span><span class="pill">Protein: ${g.p} g</span><span class="pill">Carbs: ${g.c} g</span><span class="pill">Fat: ${g.f} g</span></div>`;
  html+=`<div class="card"><h4>Target check</h4>
    <p>Protein: ${targ.pMin}-${targ.pMax} → ${g.p>=targ.pMin&&g.p<=targ.pMax?'<span class="ok">OK</span>':'<span class="warn">OUT</span>'}</p>
    <p>Carbs: ${targ.cMin}-${targ.cMax} → ${g.c>=targ.cMin&&g.c<=targ.cMax?'<span class="ok">OK</span>':'<span class="warn">OUT</span>'}</p>
    <p>Fat: ${targ.fMin}-${targ.fMax} → ${g.f>=targ.fMin&&g.f<=targ.fMax?'<span class="ok">OK</span>':'<span class="warn">OUT</span>'}</p>
    <p>Calories: ${targ.calMin}-${targ.calMax} → ${g.cal>=targ.calMin&&g.cal<=targ.calMax?'<span class="ok">OK</span>':'<span class="warn">OUT</span>'}</p></div>`;
  html+=`<div class="small muted">Supplements: Multi (breakfast), Omega 3-6-9 (lunch/dinner), Magnesium Glycinate (evening), optional Creatine with shake.</div></div>`;
  result.innerHTML=html;
  window._last={plan,tot:g};
}

function exportCSV(){
  if(!window._last){alert("Generate first");return;}
  let rows=[["Meal","Food","Qty","Calories","Protein","Carbs","Fat"]];
  window._last.plan.meals.forEach((m,i)=>{
    m.items.forEach(it=>{
      rows.push([`Meal ${i+1}`,it.name,it.qty||1,it.kcal,it.p,it.c,it.f]);
    });
    rows.push([`Meal ${i+1} subtotal`,"","",m.items.reduce((a,b)=>a+b.kcal,0),
      m.items.reduce((a,b)=>a+b.p,0),m.items.reduce((a,b)=>a+b.c,0),m.items.reduce((a,b)=>a+b.f,0)]);
  });
  rows.push(["TOTAL","","",window._last.tot.cal,window._last.tot.p,window._last.tot.c,window._last.tot.f]);
  let csv=rows.map(r=>r.join(",")).join("\n");
  let blob=new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="mealplan.csv";
  a.click();
}
</script>
</body>
</html>
