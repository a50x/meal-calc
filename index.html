<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Safe Foods — Meal Plan Generator (Advanced)</title>
  <style>
    :root{--bg:#f7fafc;--card:#fff;--muted:#64748b;--accent:#06b6d4}
    body{font-family:Inter,system-ui,-apple-system,Arial;margin:18px;background:var(--bg);color:#0f172a}
    h1{margin:0 0 8px}
    .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(11,20,37,0.06);margin-bottom:12px}
    label{display:inline-block;margin-right:10px;font-size:14px}
    input[type=number], select { padding:6px; margin-right:10px; width:110px; }
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    button{background:var(--accent);color:white;border:none;padding:9px 12px;border-radius:8px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
    .pill{display:inline-block;padding:8px 12px;border-radius:999px;background:#eef2f7;margin-right:8px}
    .muted{color:var(--muted)}
    .ok{color:green}.warn{color:crimson}
    .small{font-size:13px;color:var(--muted)}
    .footer-note{font-size:13px;color:#334155;margin-top:8px}
  </style>
</head>
<body>
  <h1>Safe Foods — Meal Plan Generator</h1>

  <div class="card">
    <div class="small muted">Use your safe-foods template. Set targets (center ± range), shakes/creami cap, meal repeats, and choose Meals or Optimal (auto-select 3–5). Generate a realistic day (3–5 meals) built from atomic combos.</div>
    <div style="height:10px"></div>

    <div class="controls">
      <div>
        <label>Calories target</label><br>
        <input id="calTarget" type="number" value="2500" /> ± <input id="calRange" type="number" value="200" />
      </div>

      <div>
        <label>Protein target (g)</label><br>
        <input id="pTarget" type="number" value="190" /> ± <input id="pRange" type="number" value="15" />
      </div>

      <div>
        <label>Carb target (g)</label><br>
        <input id="cTarget" type="number" value="215" /> ± <input id="cRange" type="number" value="15" />
      </div>

      <div>
        <label>Fat target (g)</label><br>
        <input id="fTarget" type="number" value="65" /> ± <input id="fRange" type="number" value="10" />
      </div>

      <div>
        <label>Meals</label><br>
        <select id="mealCount">
          <option value="3">3</option>
          <option value="4" selected>4</option>
          <option value="5">5</option>
          <option value="optimal">Optimal (3–5)</option>
        </select>
      </div>

      <div>
        <label>Max shakes/creami (full portions)</label><br>
        <input id="maxShakes" type="number" value="2" />
      </div>

      <div>
        <label>Meal repeats allowed</label><br>
        <input id="maxRepeats" type="number" value="1" />
      </div>

      <div style="min-width:200px">
        <button onclick="generate()">Generate Day</button>
        <button onclick="exportCSV()" style="background:#2563eb;margin-left:8px">Export CSV</button>
      </div>
    </div>

    <div class="footer-note">Notes: "Atomic combos" (cereal+milk, tenders+ketchup, rice+butter) are built-in. The generator tries many randomized candidate days and returns the best match to your targets. If no plan is found, widen ranges or increase shakes/meal repeats.</div>
  </div>

  <div id="result"></div>

<script>
let FOODS = []; // will be loaded from foods.json

// ===========================
// Helpers
// ===========================
function clone(obj){ return JSON.parse(JSON.stringify(obj)); }
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function sample(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function pickPortion(food){
  if(!food.portionable) return {...food, qty:1};
  const qty = rand(food.min, food.max);
  return {
    ...food,
    qty,
    kcal: food.kcal*qty,
    p: food.p*qty,
    c: food.c*qty,
    f: food.f*qty,
    name:`${food.name} x${qty} ${food.unit}${qty>1?'s':''}`
  };
}

function getTargetsFromUI(){
  const calT = Number(document.getElementById('calTarget').value);
  const calR = Number(document.getElementById('calRange').value);
  const pT = Number(document.getElementById('pTarget').value);
  const pR = Number(document.getElementById('pRange').value);
  const cT = Number(document.getElementById('cTarget').value);
  const cR = Number(document.getElementById('cRange').value);
  const fT = Number(document.getElementById('fTarget').value);
  const fR = Number(document.getElementById('fRange').value);

  return {
    calMin: Math.max(0, calT - calR),
    calMax: calT + calR,
    pMin: Math.max(0, pT - pR),
    pMax: pT + pR,
    cMin: Math.max(0, cT - cR),
    cMax: cT + cR,
    fMin: Math.max(0, fT - fR),
    fMax: fT + fR
  };
}

function isShake(item){ return item.tags && item.tags.includes('shake'); }

function scoreCandidate(totals, targets){
  const pMid = (targets.pMin + targets.pMax)/2;
  const cMid = (targets.cMin + targets.cMax)/2;
  const fMid = (targets.fMin + targets.fMax)/2;
  const calMid = (targets.calMin + targets.calMax)/2;
  return Math.abs(totals.p - pMid)*4 + Math.abs(totals.c - cMid)*2 + Math.abs(totals.f - fMid)*1 + Math.abs(totals.cal - calMid)*0.2;
}

// ===========================
// Day generation logic
// ===========================
function buildCandidate(mealCount){
  const maxShakes = Number(document.getElementById('maxShakes').value);
  const maxRepeats = Number(document.getElementById('maxRepeats').value);

  let meals = [], totals = {cal:0,p:0,c:0,f:0}, shakesUsed = 0, foodCounts={};

  for(let m=0;m<mealCount;m++){
    let mealItems=[];
    let itemCount = rand(1,3);
    let attempts = 0;
    while(mealItems.length<itemCount && attempts<40){
      attempts++;
      const candidate = pickPortion(sample(FOODS));

      if(isShake(candidate) && shakesUsed+1>maxShakes) continue;
      if((foodCounts[candidate.id]||0)+1>maxRepeats) continue;

      mealItems.push(candidate);
      totals.cal += candidate.kcal;
      totals.p += candidate.p;
      totals.c += candidate.c;
      totals.f += candidate.f;
      if(isShake(candidate)) shakesUsed++;
      foodCounts[candidate.id]=(foodCounts[candidate.id]||0)+1;
    }
    if(mealItems.length===0) return null;
    meals.push({items:mealItems});
  }
  return {meals, totals, shakesUsed};
}

function findBestForMealCount(mealCount, params){
  let best=null;
  for(let i=0;i<2200;i++){
    const cand=buildCandidate(mealCount);
    if(!cand) continue;
    if(cand.totals.cal>params.calMax) continue;
    const score = scoreCandidate(cand.totals, params);
    if(!best || score<best.score){ cand.score=score; best=cand; }
    if(cand.totals.p>=params.pMin && cand.totals.p<=params.pMax &&
       cand.totals.c>=params.cMin && cand.totals.c<=params.cMax &&
       cand.totals.f>=params.fMin && cand.totals.f<=params.fMax &&
       cand.totals.cal>=params.calMin && cand.totals.cal<=params.calMax) return cand;
  }
  return best;
}

function generate(){
  const targets=getTargetsFromUI();
  const mealCountChoice=document.getElementById('mealCount').value;
  const params={...targets};

  let candidates=[];
  if(mealCountChoice==='optimal'){
    for(let m=3;m<=5;m++){
      const cand=findBestForMealCount(m, params);
      if(cand) candidates.push(Object.assign({mealCount:m},cand));
    }
    if(candidates.length===0){
      document.getElementById('result').innerHTML=`<div class="card"><strong>No plan found.</strong></div>`;
      return;
    }
    candidates.sort((a,b)=>a.score-b.score);
    var best=candidates[0];
  } else {
    const m=Number(mealCountChoice);
    const cand=findBestForMealCount(m, params);
    if(!cand){ document.getElementById('result').innerHTML=`<div class="card"><strong>No plan found for ${m} meals.</strong></div>`; return;}
    var best=Object.assign({mealCount:m}, cand);
  }

  renderResult(best, params);
}

// ===========================
// Rendering + CSV export
// ===========================
function renderResult(plan, params){
  const out=document.getElementById('result');
  let html=`<div class="card"><h3>Generated Day — ${plan.mealCount} meals</h3>`;
  let grand={cal:0,p:0,c:0,f:0};
  plan.meals.forEach((meal,idx)=>{
    let mcal=0, mp=0, mc=0, mf=0;
    html+=`<h4>Meal ${idx+1}</h4><table><thead><tr><th>Food</th><th>kcal</th><th>P</th><th>C</th><th>F</th></tr></thead><tbody>`;
    meal.items.forEach(it=>{
      html+=`<tr><td>${it.name}</td><td>${it.kcal.toFixed(0)}</td><td>${it.p.toFixed(1)}</td><td>${it.c.toFixed(1)}</td><td>${it.f.toFixed(1)}</td></tr>`;
      mcal+=it.kcal; mp+=it.p; mc+=it.c; mf+=it.f;
    });
    html+=`<tr style="font-weight:700"><td>Meal subtotal</td><td>${mcal.toFixed(0)}</td><td>${mp.toFixed(1)}</td><td>${mc.toFixed(1)}</td><td>${mf.toFixed(1)}</td></tr>`;
    html+=`</tbody></table>`;
    grand.cal+=mcal; grand.p+=mp; grand.c+=mc; grand.f+=mf;
  });

  html+=`<div style="margin-top:10px"><span class="pill">Calories: <strong>${grand.cal.toFixed(0)}</strong></span>
         <span class="pill">Protein: <strong>${grand.p.toFixed(1)} g</strong></span>
         <span class="pill">Carbs: <strong>${grand.c.toFixed(1)} g</strong></span>
         <span class="pill">Fat: <strong>${grand.f.toFixed(1)} g</strong></span></div>`;

  const okP=(grand.p>=params.pMin&&grand.p<=params.pMax);
  const okC=(grand.c>=params.cMin&&grand.c<=params.cMax);
  const okF=(grand.f>=params.fMin&&grand.f<=params.fMax);
  const okCal=(grand.cal>=params.calMin&&grand.cal<=params.calMax);

  html+=`<div class="card"><h4>Target check</h4>
        <p>Protein: ${params.pMin}–${params.pMax} → ${okP?'<span class="ok">OK</span>':'<span class="warn">OUT</span>'}</p>
        <p>Carbs: ${params.cMin}–${params.cMax} → ${okC?'<span class="ok">OK</span>':'<span class="warn">OUT</span>'}</p>
        <p>Fat: ${params.fMin}–${params.fMax} → ${okF?'<span class="ok">OK</span>':'<span class="warn">OUT</span>'}</p>
        <p>Calories: ${params.calMin}–${params.calMax} → ${okCal?'<span class="ok">OK</span>':'<span class="warn">OUT</span>'}</p>
       </div>`;
  html+=`<div class="small muted">Supplements suggested: Emerald Labs Men's 1-Daily Multi (breakfast); NOW Super Omega 3-6-9 (lunch/dinner); Magnesium Glycinate (evening); optional Creatine with a shake.</div>`;
  html+=`</div>`;
  out.innerHTML=html;

  window._lastPlan={plan,totals:grand};
}

function exportCSV(){
  if(!window._lastPlan){ alert('Generate a plan first'); return; }
  const rows=[['Meal','Food','Qty','Calories','Protein(g)','Carbs(g)','Fat(g)']];
  window._lastPlan.plan.meals.forEach((meal,mi)=>{
    meal.items.forEach(it=>{
      rows.push([`Meal ${mi+1}`, it.name, it.qty||1, it.kcal.toFixed(0), it.p.toFixed(1), it.c.toFixed(1), it.f.toFixed(1)]);
    });
  });
  rows.push(['TOTAL','', '', window._lastPlan.totals.cal.toFixed(0), window._lastPlan.totals.p.toFixed(1), window._lastPlan.totals.c.toFixed(1), window._lastPlan.totals.f.toFixed(1)]);
  const csv=rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\n');
  const blob=new Blob([csv], {type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='mealplan.csv'; a.click(); URL.revokeObjectURL(url);
}

// ===========================
// Load foods.json and init
// ===========================
fetch('foods.json')
  .then(r=>r.json())
  .then(data=>{
    FOODS=data;
    generate();
  })
  .catch(err=>{
    document.getElementById('result').innerHTML="<div class='card'><strong>Error loading foods.json</strong><br>"+err+"</div>";
  });
</script>
</body>
</html>
